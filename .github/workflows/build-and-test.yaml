name: Build and Test

on:
  workflow_call:
    secrets:
      SLACK_WEBHOOK:
        description: 'Slack Notifier Webhook'
        required: true
jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-15]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 40

    env:
      # XCODE_VERSION: 26.0.1
      # SIM_DEVICE_NAME: iPhone 16
      # SIM_OS_VERSION: 18.6
      XCODE_VERSION: ${{ vars.XCODE_VERSION }}
      SIM_DEVICE_NAME: ${{ vars.SIM_DEVICE_NAME }}
      SIM_OS_VERSION: ${{ vars.SIM_OS_VERSION }}

    steps:
      # Clone the repository
      - name: Clone the repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{github.event.pull_request.head.repo.full_name}}
          fetch-depth: 1

      # Get the architecture of the chip
      - name: Check chip architecture 
        run: echo "CHIP_TYPE=$(uname -m)" >> $GITHUB_ENV    

      # Set up Xcode (faster and cleaner than manual xcode-select)
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      # Cache DerivedData to speed up rebuilds
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('**/*.xcodeproj/**', '**/*.xcworkspace/**') }}

      # Cache dependencies (SPM or CocoaPods)
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.carthage.CarthageKit
            ~/Library/Caches/com.apple.dt.Xcode
            **/Pods
          key: ${{ runner.os }}-deps-${{ hashFiles('**/Podfile.lock', '**/Package.resolved') }}

      # Run all tests
      - name: Run tests
        run: |
          DEST="platform=iOS Simulator,name=${SIM_DEVICE_NAME},OS=${SIM_OS_VERSION}"
          echo "Running tests on $DEST"

          xcodebuild test \
          -scheme PingTestHost \
          -workspace SampleApps/Ping.xcworkspace \
          -configuration Debug \
          -destination "$DEST" \
          -derivedDataPath DerivedData \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults 
          

      # Publish test results
      - name: Publish test results
        uses: slidoapp/xcresulttool@v3.1.0
        with:
          title: "Test Results ${{ matrix.os }} - ${{ env.CHIP_TYPE }}"
          path: TestResults.xcresult
          show-passed-tests: false
          upload-bundles: never
        if: success() || failure()
 
      # Send slack notification with result status
      - uses: 8398a7/action-slack@v3
        with:
          mention: 'stoyan.petrov'
          if_mention: 'failure,cancelled'
          fields: repo,author,eventName,message,job,pullRequest,took
          status: ${{ job.status }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        if: always()